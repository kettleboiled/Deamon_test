name: Deploy Course to Production

on:
  push:
    branches: [ "main" ]
    paths:
      - '**.zip' # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –∞—Ä—Ö–∏–≤—ã

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: '**.zip'

      - name: Set up Python
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: pip install -r requirements.txt

      - name: Deploy Changed Courses
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          LMS_API_URL: ${{ secrets.LMS_API_URL }}     # –ë–µ—Ä–µ–º –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ —Ä–µ–ø–æ
          LMS_API_TOKEN: ${{ secrets.LMS_API_TOKEN }} # –ë–µ—Ä–µ–º –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ —Ä–µ–ø–æ
        run: |
          # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –≤—Å–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º zip —Ñ–∞–π–ª–∞–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö
          for file in $ALL_CHANGED_FILES; do
            echo "üöÄ Deploying $file..."
            python -m parser.runner "$file"
          done